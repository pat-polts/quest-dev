/*
 quest-dev 2016-09-06 
*/
var quest=angular.module("questApp",["ngRoute","ngMaterial","ngCookies"]);quest.config(function(a,b){a.when("/",{templateUrl:"../../views/saudacoes.html",restricted:!0}).when("/login",{templateUrl:"../../views/login.html",controller:"authController",restricted:!1}).when("/logout",{controller:"authController",restricted:!0,resolve:{load:function(a,b){return b.logout()}}}).when("/register",{templateUrl:"../../views/register.html",controller:"authController",restricted:!0}).when("/mais-sobre",{templateUrl:"../../views/mais-sobre.html",restricted:!0}).when("/vamos-jogar",{templateUrl:"../../views/vamos-jogar.html",restricted:!0}).when("/game",{templateUrl:"../../views/game_copy.html",restricted:!0}).otherwise({redirectTo:"/login"})}),quest.run(function(a,b,c,d,a,e){a.$on("$routeChangeStart",function(a,c,d){c&&c.$$route&&c.$$route.restricted&&(e.logged()||(a.preventDefault(),b.path("/login")))}),a.$on("$stateChangeStart",function(a,c,d){c&&c.$$route&&c.$$route.restricted&&(e.logged()||(a.preventDefault(),b.path("/login")))})}),quest.factory("ApiService",["$rootScope","$q","$timeout","$http","$location","AuthService",function(a,b,c,d,e,f){var g={};return g.getUserData=function(){a.isLoading=!0,d.get("/api/user").then(function(b){if(b.data.user){a.isLoading=!1;var c=b.data.user;a.userData.userName=c.Nome,a.userData.userScore=c.Pontuacao}},function(b){b.data.error&&(a.error=!0,a.errorMessage=b.data.error)})},g}]),quest.factory("AuthService",["$rootScope","$q","$timeout","$http","$cookies","$location",function(a,b,c,d,e,f){var g={},h=36e5;new Date(Date.now()+h);return g.api=function(){d.get("/api").success(function(a,b){return a.api}).error(function(){a.error=!0,a.errorMessage="Problemas com a api"})},g.login=function(b,c){var e={Login:b,Senha:c};a.isLoading=!0,d.post("/auth/login",e).then(function(b){return a.isLoading=!1,f.path("/")},function(b){a.error=!0,a.errorMessage="Erro inesperado!"})},g.logged=function(){var c=b.defer();return d.get("/auth/status").success(function(a){c.resolve()}).error(function(){return a.error=!0,a.errorMessage="Efetue login",c.reject(),f.path("/login")}),c.promise},g.logout=function(){d.get("/auth/logout").then(function(b){if(a.isLoading=!1,!b.data.logged)return f.path("/login")},function(a){console.log("erro ao deslogar")})},g}]),quest.factory("BoardService",["$rootScope","$q","$timeout","$http","ApiService",function(a,b,c,d,e){var f=(b.defer(),0),g=30,h={score:"10",question:["title","options","correct"],answer:"",special:!1,x:0,y:0},i=[1,2,3,4,5,6],j={},k={};return k.getQuestions=function(){return d.get("/api/questions").then(function(b){a.isLoading=!1,200===b.status&&(j.questions=b.data)},function(a){500===a.status?console.log("erro ao pegar questao"):console.log("erro desconhecido")}),j},k.getGameApi=function(){return i},k.createBoard=function(){for(var a=[],b=0;b<g;b++)a[b]=h;return a},k.getBoard=function(){return i},k.getBoardData=function(){return j},k.getHouses=function(){return h},k.getScore=function(){return f},k}]),quest.directive("setHeight",function(a,b){return{link:function(a,c,d){a.height=b.innerHeight+"px",c.css("height",a.height),angular.element(b).bind("resize",function(){a.height=b.innerHeight+"px",c.css("height",a.height),a.$digest()})}}}),quest.directive("setQuestion",function(a,b){return{link:function(a,c,d){var e,f;a.palco=angular.element(document).find("canvas"),f=a.palco[0].offsetHeight-50,e=a.palco[0].offsetWidth-50,a.palcoW=e+"px",a.palcoH=f+"px",c.css("height",a.palcoH),c.css("width",a.palcoW),angular.element(b).bind("resize",function(){f=a.palco[0].offsetHeight-50,e=a.palco[0].offsetWidth-50,a.palcoW=e+"px",a.palcoH=f+"px",c.css("height",a.palcoH),c.css("width",a.palcoW),a.$digest()})}}}),quest.directive("board",["$rootScope","$http","BoardService","AuthService",function(a,b,c,d){return{restrict:"EAC",replace:!0,scope:{score:"=score",boardData:"=boardData"},template:'<canvas id="game" width="1024" height="768" set-height></canvas>',link:function(e,f,g){function h(){e.stage?(e.stage.autoClear=!0,e.stage.removeAllChildren(),e.stage.update()):e.stage=new createjs.Stage(f[0]),q=e.stage.canvas.width,r=e.stage.canvas.height,t=[{src:"current-marker.png",id:"currentMarker"},{src:"house-marker.png",id:"marker"},{src:"board.png",id:"board"}],s=new createjs.LoadQueue(!1),s.addEventListener("complete",j),s.loadManifest(t,!0,"/dist/assets/")}function i(){d.logged(),b.get("/api/user").then(function(b){return 200===b.status&&b.data.user&&(a.activeHouse=b.data.user.UltimaPerguntaRespondida),a.activeHouse},function(a){500===a.status&&console.log("erro inesperado")}),v=a.activeHouse&&0!==a.activeHouse?a.activeHouse:1}function j(){var a=(s.getResult("marker"),s.getResult("currentMarker"),c.getBoard()),b=(c.getBoardData(),a.length,Math.floor(q/3));Math.floor(b/6),Math.floor(b/7);u=new createjs.Shape;var d=s.getResult("board");u.graphics.beginBitmapFill(d).drawRect(0,0),e.stage.addChild(u);var f=!1,g=v;if(1===g)var h=1;else var h=g+1;console.log(h);for(var i=1;i<32;i++)i<7?k(h,1,i,f):i>6&&i<13?(f=12===i,k(h,2,i,f)):i>13&&i<20?(f=!1,k(h,3,i,f)):i>19&&i<22?(f=!1,k(h,4,i,f)):i>22&&i<29?(f=23===i||27===i,k(h,5,i,f)):i>28&&i<33&&(f=!1,k(h,6,i,f));l(h),createjs.Ticker.timingMode=createjs.Ticker.RAF,createjs.Ticker.addEventListener("tick",p)}function k(a,b,c,d){var f=q/3,g=Math.round(r/3),h="white",i=new createjs.Shape,j=(s.getResult("currentMarker"),new createjs.Shape),k=Math.round(f)/6,l=Math.round(g)/6;switch(d&&(h="#37d349"),b){case 1:var n=Math.round(k)*c,o=210;break;case 2:var p=6*Math.round(k),n=p;if(7===c)var o=g;else var o=g+Math.round(l)*(c-7)+c;break;case 3:var t=g+5*Math.round(l)+12,o=t,p=6*Math.round(k)+16;if(14===c)var n=p+28;else var u=p+28,n=u+2*c*(c-14)+c;break;case 4:var p=6*Math.round(k)+16,u=p+28;if(20===c)var o=g+4*Math.round(l)+11;else var o=g+3*Math.round(l)+10;var n=u+190+19;break;case 5:var o=g+3*Math.round(l)+10,v=Math.round(2*f)-50;if(23===c)var n=v;else var n=v+2*c*(c-23)-5;break;case 6:var v=Math.round(2*f)-50;g+4*Math.round(l)+11;if(29===c)var o=429;else if(30===c)var o=459;else var o=489;var n=v+280-5}i.graphics.beginStroke("#9a9c9e").beginFill(h).drawCircle(0,0,12),i.x=n,i.y=o,i.name=c,i.on("click",m),e.stage.addChild(i),a===c&&(j.graphics.beginFill("#e8a612").drawRoundRect(0,0,31,45,17),j.x=i.x-16,j.y=i.y-20,e.stage.addChild(j))}function l(c){c&&b.get("/api/question/"+c).then(function(b){b.data.question&&(a.isQuestion=!0,a.questionData=b.data.question)},function(a){console.log("erro ao obter pergunta")})}function m(){var a=this,b=a.name,c=(new createjs.Shape,b+1),d=b-1,f=e.boardData.questions.data;return 0===d||f[d].Respondida?f[b]?l(f[b].Respondida?f[c]:f[b]):void 0:n(d)}function n(a){var b=new createjs.Shape;b.graphics.beginFill("#fff").drawRoundRect(0,0,500,180,10),txt=new createjs.Text("Responda a "+a+"Â° pergunta para prosseguir!","22px Arial","#c00"),b.x=300,b.y=300,txt.x=350,txt.y=350,b.on("click",function(a){e.stage.removeChild(b,txt),o(next)}),e.stage.addChild(b,txt)}function o(a){return l(a)}function p(a){e.stage.update(a)}var q,r,s,t,u,v;i(),h(),a.nextQuestion=function(a){return l(a)}}}}]),quest.directive("question",["$rootScope","$http","BoardService",function(a,b,c){return{templateUrl:"../../views/templates/question_copy.html",scope:{questionData:"=questionData"},link:function(c,d,e){function f(c){c&&(console.log(c),console.log(a.userData.userScore),a.isLoading=!0,b.get("/api/question/"+c).then(function(b){a.isLoading=!1,b.data.question&&(a.isQuestion=!0,a.questionData=b.data.question)},function(a){console.log("erro ao obter pergunta")}))}var g=c.questionData,h=null;g&&(c.id=g.Numero,c.title=g.Titulo,c.desc=g.Descricao,c.score=g.ValorPontuacao,c.answered=g.Respondida,c.options=g.Alternativas,c.correct=g.ValorAlternativaCorreta),c.choose=!1,c.selectOption=function(){var d=this;h=d.alt.Valor;d.$index;h===c.correct?(a.activeScore=c.score,a.userData.userScore+=parseInt(a.activeScore),console.log("yep"),console.log("Acertou, mais "+c.score+" pontos")):(console.log("ounch"),console.log("reposta certa seria: "+c.correct)),c.answered=!0,a.activeHouse=c.id,b.post("/api/question",{numero:c.id,valor:h},function(a){200===a.status&&console.log("ok, move next")},function(a){500===a.status&&console.log("erro ao gravar a pergunta")})},c.choose=function(){h||console.log("responda a pergunta");var b=parseInt(a.activeHouse)+1;return console.log(b),a.isQuestion=!1,f(b)}}}}]),quest.controller("mainController",["$rootScope","$scope","$location","$cookies","AuthService","BoardService","ApiService",function(a,b,c,d,e,f,g){a.isLoading=!1,a.activePage=c.path(),a.userActive=!1,a.question=!1,a.special=!1,a.currentLevel=null,a.currentScore=null,a.levels=[],a.score=f.getScore(),a.boardData=f.getQuestions(),a.activeHouse=!1,a.activeScore=!1,a.answer=0,a.correctAnswer=0,a.isQuestion=!1,a.questionData={},a.userData={},a.userGetData=function(){return g.getUserData()},a.go=function(a){c.path(a)},a.$watch("activeScore",function(b){return a.activeScore}),a.$watch("activeHouse",function(b){return a.activeHouse}),a.$watch("isQuestion"),a.$watch("userData")}]),quest.controller("authController",["$rootScope","$scope","$location","$http","$cookies","AuthService",function(a,b,c,d,e,f){a.isLoading=!1,a.userActive=null,a.checkFields=function(){return!(!b.loginForm.username||!b.loginForm.password)},a.login=function(){return a.error=!1,a.disabled=!1,a.checkFields()?f.login(b.loginForm.username,b.loginForm.password):(a.error=!0,void(a.errorMessage="Preencha os campos para prosseguir"))},a.logged=function(){f.logged()}}]),quest.controller("logoutController",["$rootScope","$scope","$location","AuthService",function(a,b,c,d){a.isLoading=!1,a.logout=function(){}}]),quest.controller("registerController",["$rootScope","$scope","$location","AuthService",function(a,b,c,d){a.isLoading=!1,a.register=function(){a.error=!1,a.disabled=!1,a.userActive=!1}}]);